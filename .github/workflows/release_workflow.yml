name: Generate new Release
run-name: Generating new Release
on:
    workflow_dispatch:
    schedule:
        - cron: '0 0 1 * *'
jobs:
  Generate-new-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
        - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."
        - name: check out repository code
          uses: actions/checkout@v4
          with:
            ssh-key: ${{ secrets.DEPLOY_KEY }}
            ref: main
            fetch-depth: 0
        - run: echo "The ${{ github.repository }} repository has been cloned to the runner."
        - name: List files in the repository
          run: |
           ls ${{ github.workspace }}
        - name: setup python
          uses: actions/setup-python@v4
          with:
            python-version: '3.10'
        - name: install dependencies
          run: |
              pip install --upgrade pip
              pip install pandas openpyxl
        - name: execute py script 
          run: python other/scripts/output_file_generator.py ${{github.workspace}}
        - name: generate release notes
          shell: bash
          run: |
            START_DATE=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m-01)
            END_DATE=$(date -d "$(date +%Y-%m-01) -1 day" +%Y-%m-%d)

            MONTH_LABEL=$(date -d "$START_DATE" +'%B %Y:')

            echo "# Commits in $MONTH_LABEL" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md

            git log \
            --since="$START_DATE" \
            --until="$END_DATE 23:59:59" \
            --date=format:'%a %b %e' \
            --pretty=format:'- %ad â€” %s (%an)' \
            >> RELEASE_NOTES.md

        - name: determine tag name
          id: vars
          shell: bash
          run: |
            TAG="monthly-$(date +'%Y-%m')"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "release_name=Automated Release $TAG" >> $GITHUB_OUTPUT
        - name: create Release
          uses: softprops/action-gh-release@v2
          with:
            tag_name: ${{ steps.vars.outputs.tag }}
            name: ${{ steps.vars.outputs.release_name }}
            generate_release_notes: false
            body_path: RELEASE_NOTES.md
            files: |
              output.xlsx